Setting up Midas again
======================

get code
--------

We pulled the git version of MidasDAQ using the following clone.

```
$ssh jiajin.spa.umn.edu
$sudo -u cdmssoft -s
$cd ~
$cd repositories/
$git clone villaa@nero.stanford.edu:/data/git/DAQ/MidasDAQ MidasDAQ
```

This goes into the top-level repositories directory where we can put all the code repository
versions and then sim-link to them at the lower levels.  For example I then did:

```
$cd ../scdmsDAQ/
$rm MidasDAQ
$ln -s ln -s /home/hep/cdmssoft/repositories/MidasDAQ
```

compile code
-----------

We then had to go into the `MidasDAQ/src` directories and make the binaries like:

```
$cd MidasDAQ/src
$make dcrc_driver.exe
$make towerfe3.exe
$make triggerfe2.exe
```

Note that the "all" tag does not make the appropriate binaries, and that the makesystem for this
code should be fixed to be a lot better. 

set the exptab
--------------

For our system at UMN the exptab needs to be changed so that it has the appropriate user and
experiment name.  It consists of the single line:

```
cdms_UMN /home/hep/cdmssoft/scdmsDAQ/MidasDAQ/online cdmssoft
```

move the startup scripts
------------------------

So there was a startup script that is included in the repository that assumes we are running an
experiment name called `cdms_test` and that our hostname begins with `dcrc01`.  Neither of these
things are true at UMN (I guess we can change them to be) so we needed a new startup script.  This
goes in the `MidasDAQ/online/bin` directory.  It is called `start_daq_local.sh`.

```
!/bin/sh

cd /home/hep/cdmssoft/scdmsDAQ/MidasDAQ/online

case `hostname` in
jiajin*)
    echo "Good, we are on jiajin!"
    ;;
*)
    echo "The start_daq script should be executed on jiajin"
    exit 1
    ;;
esac

odbedit -c clean

mhttpd  -p 8081 -D -e cdms_UMN
mserver -p 7071 -D
mlogger -D -e cdms_UMN

end file
```

With the current setup in response to this script we got:

```
Good, we are on jiajin!
[ODBEdit,ERROR] [system.c:1021:ss_shm_delete,ERROR] shm_unlink(/cdms_UMN_SYSMSG_SHM) errno 2 (No such file or directory)
[ODBEdit,ERROR] [system.c:1021:ss_shm_delete,ERROR] shm_unlink(/cdms_UMN_SYSTEM_SHM) errno 2 (No such file or directory)
Becoming a daemon...
mserver started interactively
Becoming a daemon...
Becoming a daemon...
```

Basically, it worked, I've seen those errors before or something like them.  I'm not totally sure
what it means, but it's clear that the ODB is not initialized totally.  We have to find out how to
populate the ODB. 

So this is what the MIDAS front-end looked like without an ODB:

![Midas no ODB](figures/midas_noODB.png)

Need to kill stuff:

```
jiajin:bin cdmssoft$ps -u cdmssoft
PID TTY          TIME CMD
25608 pts/0    00:00:00 bash
28584 pts/1    00:00:00 bash
29350 ?        00:00:00 mhttpd
29352 ?        00:00:00 mserver
29355 ?        00:00:00 mlogger
29577 pts/0    00:00:00 ps
jiajin:bin cdmssoft$kill -9 29350
jiajin:bin cdmssoft$kill -9 29355
jiajin:bin cdmssoft$kill -9 29352
```

Setup the new ODB (annoying! and poorly documented)
--------------------------------------------------

So we are following the file `documentation/triumf_dcrc_installation.txt` in the MidasDAQ repo.
It's a little unclear, but after the making of executables that we did above, and changing of
exptab, we need to recreate the ODB. 

First we need to remove the .ODB.SHM that we just created by (incorrectly) running Midas.  This
will be in the Midas experimental directory as set by `exptab` (I guess).  Then set up a new blank
ODB with the right size:

```
odbedit -s 4194304
```

Got this error, and the instructions say that it's "normal:"

```
[ODBEdit,ERROR] [system.c:1021:ss_shm_delete,ERROR] shm_unlink(/cdms_UMN_ODB_SHM) errno 2 (No such file or directory)
```

Then add a couple of new keys to the ODB:

```
jiajin:online cdmssoft$odbedit
[local:cdms_UMN:S]/>create DWORD /Experiment/MAX_EVENT_SIZE
[local:cdms_UMN:S]/>set /Experiment/MAX_EVENT_SIZE 25600000
[local:cdms_UMN:S]/>create DWORD "/Experiment/Buffer sizes/SYSTEM"
[local:cdms_UMN:S]/>set "/Experiment/Buffer sizes/SYSTEM" 256000000
[local:cdms_UMN:S]/>exit
jiajin:online cdmssoft$odbedit
[local:cdms_UMN:S]/>ls
System                          
Programs                        
Experiment                      
Logger                          
Runinfo                         
Alarms                          
[local:cdms_UMN:S]/>ls Experiment/
Name                            cdms_UMN
Buffer sizes                    
MAX_EVENT_SIZE                  25600000
[local:cdms_UMN:S]/>              
[local:cdms_UMN:S]/>ls "Experiment/Buffer sizes/
SYSMSG                          100000
SYSTEM                          256000000
[local:cdms_UMN:S]/>exit
```

Note the command `odbedit -c clean` doesn't work for us, it seems to just return, when the desired
behavior is to be dropped into an odb edit session, as above.
